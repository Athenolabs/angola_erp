[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Salary Structure", 
  "modified": "2016-10-11 10:58:55.825721", 
  "name": "Salary Structure-Client", 
  "script": "// Copyright (c) 2016, HELKyds lda. and contributors\n// For license information, please see license.txt\n\nvar irt=0;\nvar inss=0;\nvar salario = 0;\nfrappe.ui.form.on('Salary Structure', {\n\trefresh: function(frm) {\n\t\t\t//Get Salario\n\t\tvar tbl1 = frm.doc.earnings || [];\n\t\tvar tbl2 = frm.doc.deductions || [];\n\n\t\tinss_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.get_inss\",args:{}})\t\n\t\tfor(var i = 0; i < tbl1.length; i++){\n\t\t\tif (tbl1[i].salary_component == \"Salario Base\" || tbl1[i].salary_component == \"Basic\" && tbl1[i].amount != 0){\n\t\t\t\tsalario = tbl1[i].amount\n\t\t\t\tirt_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.get_irt\",args:{\"start\":salario}})\n\t\t\t}\n\t\t}\t\n\n\t\tif(!frm.doc.__islocal) {\n\t\t\tcur_frm.add_custom_button(__('Calcular IRT & INSS'),function(doc, cdt, cdn) {\n\n\t\t\t\tfor(var i = 0; i < tbl1.length; i++){\n\t\t\t\t\tif (tbl1[i].salary_component == \"Salario Base\" || tbl1[i].salary_component == \"Basic\" && tbl1[i].amount != 0){\n\t\t\t\t\t\tif (irt_valor.responseJSON.message[0].valor_inicio !=undefined){\n\t\t\t\t\t\t\tirt = flt(salario) - irt_valor.responseJSON.message[0].valor_inicio;\n\t\t\t\t\t\t\tirt = (irt * irt_valor.responseJSON.message[0].valor_percentual/ 100) + irt_valor.responseJSON.message[0].parcela_fixa;\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tirt = flt(salario) - irt_valor.responseJSON.message[0][0];\n\t\t\t\t\t\t\tirt = (irt * irt_valor.responseJSON.message[0][2]/ 100) + irt_valor.responseJSON.message[0][3];\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\t\t\t\t\t\t\t\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\tfor(var j = 0; j < tbl2.length; j++){\n\t\t\t\t\tif (tbl2[j].salary_component == \"IRT\" ){\n\t\t\t\t\t\tirt_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.set_ded\",args:{\"ded\":tbl2[j].name,\"d_val\":irt}});\n\t\t\t\t\t}else if (tbl2[j].salary_component == \"INSS\" ){\t\n\t\t\t\t\t\tif (inss_valor.responseJSON.message !=undefined){\n\t\t\t\t\t\t\t//inss_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.get_inss\",args:{}})\t\n\t\t\t\t\t\t\tinss_valor =cur_frm.call({method:\"angola_erp.angola_erpnext.validations.irt.set_ded\",args:{\"ded\":tbl2[j].name,\"d_val\":flt(salario)*inss_valor.responseJSON.message}});\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\talert(\"INSS\")\n\t\t\t\t\t\t}\n\t\t\t\t\t}\t\n\t\t\t\t}\n\t\t\t\tcur_frm.refresh()\n\t\t\t\tcur_frm.reload_doc()\n\t\t\t\tcalculate_totals(frm.doc);\n\t\t\t});\n\t\t}\n\n\t},\n\t\n\tonload: function(frm){\n\t\tfrm.set_query(\"salary_component\", \"earnings\", function(doc, cdt, cdn) {\n\t\t\treturn {\n\t\t\t\t\"filters\": {\n\t\t\t\t\t\"abono\": 1,\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t\tfrm.set_query(\"salary_component\", \"deductions\", function(doc, cdt, cdn) {\n\t\t\treturn {\n\t\t\t\t\"filters\": {\n\t\t\t\t\t\"desconto\": 1,\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t\tcalculate_totals(frm.doc);\n\t},\n});\n\n", 
  "script_type": "Client"
 }
]